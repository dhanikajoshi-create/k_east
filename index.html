<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title></title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/6Buildingsbuildings_1.js"></script>
        <script src="data/5Openopenspaces_2.js"></script>
        <script src="data/Roads_3.js"></script>
        <script src="data/3Waterwayswaterways_4.js"></script>
        <script src="data/2Vegetationvegetation_5.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[19.111145378299163,72.84794658997396],[19.11350217675392,72.85271382847996]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // add class to format popup if it contains media
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					// Delay to force the redraw
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_CartoLight_0');
        map.getPane('pane_CartoLight_0').style.zIndex = 400;
        var layer_CartoLight_0 = L.tileLayer('https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.pn', {
            pane: 'pane_CartoLight_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
        });
        layer_CartoLight_0;
        map.addLayer(layer_CartoLight_0);
        function pop_6Buildingsbuildings_1(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['bldg_use'] !== null ? autolinker.link(String(feature.properties['bldg_use']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['wall_ml'] !== null ? autolinker.link(String(feature.properties['wall_ml']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['bldg_ht'] !== null ? autolinker.link(String(feature.properties['bldg_ht']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['floor'] !== null ? autolinker.link(String(feature.properties['floor']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['roof_ml'] !== null ? autolinker.link(String(feature.properties['roof_ml']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['bldg_area'] !== null ? autolinker.link(String(feature.properties['bldg_area']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_6Buildingsbuildings_1_0() {
            return {
                pane: 'pane_6Buildingsbuildings_1',
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(89,89,89,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_6Buildingsbuildings_1');
        map.getPane('pane_6Buildingsbuildings_1').style.zIndex = 401;
        map.getPane('pane_6Buildingsbuildings_1').style['mix-blend-mode'] = 'normal';
        var layer_6Buildingsbuildings_1 = new L.geoJson(json_6Buildingsbuildings_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_6Buildingsbuildings_1',
            layerName: 'layer_6Buildingsbuildings_1',
            pane: 'pane_6Buildingsbuildings_1',
            onEachFeature: pop_6Buildingsbuildings_1,
            style: style_6Buildingsbuildings_1_0,
        });
        bounds_group.addLayer(layer_6Buildingsbuildings_1);
        map.addLayer(layer_6Buildingsbuildings_1);
        function pop_5Openopenspaces_2(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['type'] !== null ? autolinker.link(String(feature.properties['type']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['area'] !== null ? autolinker.link(String(feature.properties['area']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['plot_no'] !== null ? autolinker.link(String(feature.properties['plot_no']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_5Openopenspaces_2_0() {
            return {
                pane: 'pane_5Openopenspaces_2',
                opacity: 1,
                color: 'rgba(157,190,146,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(187,221,182,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_5Openopenspaces_2');
        map.getPane('pane_5Openopenspaces_2').style.zIndex = 402;
        map.getPane('pane_5Openopenspaces_2').style['mix-blend-mode'] = 'normal';
        var layer_5Openopenspaces_2 = new L.geoJson(json_5Openopenspaces_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_5Openopenspaces_2',
            layerName: 'layer_5Openopenspaces_2',
            pane: 'pane_5Openopenspaces_2',
            onEachFeature: pop_5Openopenspaces_2,
            style: style_5Openopenspaces_2_0,
        });
        bounds_group.addLayer(layer_5Openopenspaces_2);
        map.addLayer(layer_5Openopenspaces_2);
        function pop_Roads_3(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td class="visible-with-data" id="fid" colspan="2"><strong>fid</strong><br />' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_name'] !== null ? autolinker.link(String(feature.properties['ro_name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_width'] !== null ? autolinker.link(String(feature.properties['ro_width']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_ml'] !== null ? autolinker.link(String(feature.properties['ro_ml']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_typo'] !== null ? autolinker.link(String(feature.properties['ro_typo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_acces'] !== null ? autolinker.link(String(feature.properties['ro_acces']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid_2'] !== null ? autolinker.link(String(feature.properties['fid_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id_2'] !== null ? autolinker.link(String(feature.properties['id_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_name_2'] !== null ? autolinker.link(String(feature.properties['ro_name_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_width_2'] !== null ? autolinker.link(String(feature.properties['ro_width_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_ml_2'] !== null ? autolinker.link(String(feature.properties['ro_ml_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_typo_2'] !== null ? autolinker.link(String(feature.properties['ro_typo_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ro_acces_2'] !== null ? autolinker.link(String(feature.properties['ro_acces_2']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Roads_3_0() {
            return {
                pane: 'pane_Roads_3',
                opacity: 1,
                color: 'rgba(142,142,142,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 2.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_Roads_3');
        map.getPane('pane_Roads_3').style.zIndex = 403;
        map.getPane('pane_Roads_3').style['mix-blend-mode'] = 'normal';
        var layer_Roads_3 = new L.geoJson(json_Roads_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Roads_3',
            layerName: 'layer_Roads_3',
            pane: 'pane_Roads_3',
            onEachFeature: pop_Roads_3,
            style: style_Roads_3_0,
        });
        bounds_group.addLayer(layer_Roads_3);
        map.addLayer(layer_Roads_3);
        function pop_3Waterwayswaterways_4(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_3Waterwayswaterways_4_0() {
            return {
                pane: 'pane_3Waterwayswaterways_4',
                opacity: 1,
                color: 'rgba(77,146,137,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 10.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_3Waterwayswaterways_4');
        map.getPane('pane_3Waterwayswaterways_4').style.zIndex = 404;
        map.getPane('pane_3Waterwayswaterways_4').style['mix-blend-mode'] = 'normal';
        var layer_3Waterwayswaterways_4 = new L.geoJson(json_3Waterwayswaterways_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_3Waterwayswaterways_4',
            layerName: 'layer_3Waterwayswaterways_4',
            pane: 'pane_3Waterwayswaterways_4',
            onEachFeature: pop_3Waterwayswaterways_4,
            style: style_3Waterwayswaterways_4_0,
        });
        bounds_group.addLayer(layer_3Waterwayswaterways_4);
        map.addLayer(layer_3Waterwayswaterways_4);
        function pop_2Vegetationvegetation_5(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(String(feature.properties['id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['girth_rad'] !== null ? autolinker.link(String(feature.properties['girth_rad']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['crown_rad'] !== null ? autolinker.link(String(feature.properties['crown_rad']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['species'] !== null ? autolinker.link(String(feature.properties['species']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['seas_type'] !== null ? autolinker.link(String(feature.properties['seas_type']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['flaura_typ'] !== null ? autolinker.link(String(feature.properties['flaura_typ']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['name'] !== null ? autolinker.link(String(feature.properties['name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_2Vegetationvegetation_5_0() {
            return {
                pane: 'pane_2Vegetationvegetation_5',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(77,146,137,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(157,190,146,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_2Vegetationvegetation_5');
        map.getPane('pane_2Vegetationvegetation_5').style.zIndex = 405;
        map.getPane('pane_2Vegetationvegetation_5').style['mix-blend-mode'] = 'normal';
        var layer_2Vegetationvegetation_5 = new L.geoJson(json_2Vegetationvegetation_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_2Vegetationvegetation_5',
            layerName: 'layer_2Vegetationvegetation_5',
            pane: 'pane_2Vegetationvegetation_5',
            onEachFeature: pop_2Vegetationvegetation_5,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_2Vegetationvegetation_5_0(feature));
            },
        });
        bounds_group.addLayer(layer_2Vegetationvegetation_5);
        map.addLayer(layer_2Vegetationvegetation_5);
        const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "France BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim OSM"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
            // resultsHandler: myHandler,
        }).addTo(map);
        photonControl._container.childNodes[0].style.borderRadius="10px"
        // Create a variable to store the geoJSON data
        var x = null;
        // Create a variable to store the marker
        var marker = null;
        // Add an event listener to the Photon control to create a marker from the returned geoJSON data
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });
        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
        search.style.backgroundColor="rgba(255,255,255,0.5)" 

        // Create the new button element
        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";

        // Insert the button at the beginning of the search control
        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });
        setBounds();
        </script>
   <!-- STEP 1: Attribute Panel & Index for your qgis2web map
     Paste this whole block near the end of index.html (just before </body>).
     It adds a clean sidebar to choose a LAYER and one ATTRIBUTE, then lists
     values for that attribute. Click a row to zoom to that feature and open a popup. -->

<style>
  /* ——— Panel styles ——— */
  #attrPanel {
    position: absolute;
    top: 12px;
    left: 12px;
    width: 320px;
    max-height: calc(100% - 24px);
    overflow: hidden;
    z-index: 1001; /* above default Leaflet controls */
    background: #fff;
    border: 1px solid #e5e7eb; /* gray-200 */
    border-radius: 14px;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
  }
  #attrPanel header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
  }
  #attrPanel .body { padding: 10px 12px; display: flex; flex-direction: column; gap: 10px; }
  #attrPanel label { font-size: 12px; color: #6b7280; }
  #attrPanel select, #attrPanel input[type="text"] {
    width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px;
  }
  #attrPanel .list { overflow: auto; max-height: 320px; border: 1px solid #f0f0f0; border-radius: 10px; }
  #attrPanel .row { display: flex; gap: 10px; align-items: center; padding: 8px 10px; border-bottom: 1px dashed #eee; cursor: pointer; }
  #attrPanel .row:hover { background: #f9fafb; }
  #attrPanel .seq { width: 2.6em; opacity: .65; font-variant-numeric: tabular-nums; }
  #attrPanel .val { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #attrPanel .footer { padding: 8px 12px; border-top: 1px solid #f0f0f0; font-size: 12px; color: #6b7280; display:flex; justify-content:space-between; align-items:center; }
  #attrPanel .pill { font-size: 11px; padding: 2px 8px; background: #f3f4f6; border-radius: 999px; }
  #attrPanel .toggle { border: none; background: transparent; cursor: pointer; font-size: 20px; line-height: 1; }
  @media (max-width: 640px){ #attrPanel { left: 8px; right: 8px; width: auto; } }
</style>

<!-- ——— Panel markup ——— -->
<div id="attrPanel" class="leaflet-top leaflet-left">
  <header>
    <strong>Data Viewer</strong>
    <button id="attrPanelToggle" class="toggle" title="Collapse">–</button>
  </header>
  <div class="body">
    <div>
      <label for="layerSelect">Layer</label>
      <select id="layerSelect"></select>
    </div>
    <div>
      <label for="attributeSelect">Attribute</label>
      <select id="attributeSelect"></select>
    </div>
    <input id="searchInput" type="text" placeholder="Filter values…" />
    <div class="list" id="indexList" role="list"></div>
  </div>
  <div class="footer">
    <span id="stats" class="pill">0 items</span>
    <span style="opacity:.6; font-size:11px;">Click a row → zoom</span>
  </div>
</div>

<script>
(function(){
  // Ensure Leaflet map is present (qgis2web creates a global `map`)
  if (!window.map || !window.L) return;

  // 1) Map your qgis2web layer variables to friendly names.
  //    Replace the right-hand side if your variables have different names.
  //    TIP: In index.html, search for:  var layer_   to discover names.
const registry = {
  "Buildings": window.layer_6Buildingsbuildings_1,
  "Vegetation": window.layer_2Vegetationvegetation_5
};

  // Remove missing layers from the registry
  Object.keys(registry).forEach(k => { if(!registry[k]) delete registry[k]; });

  // ——— Elements ———
  const els = {
    panel: document.getElementById('attrPanel'),
    toggle: document.getElementById('attrPanelToggle'),
    layer: document.getElementById('layerSelect'),
    attr: document.getElementById('attributeSelect'),
    search: document.getElementById('searchInput'),
    list: document.getElementById('indexList'),
    stats: document.getElementById('stats')
  };

  // ——— Helpers ———
  function getAttributes(geoLayer){
    // sample first feature to derive property keys
    let attrs = new Set();
    let gotOne = false;
    if (!geoLayer) return [];
    geoLayer.eachLayer(l => {
      if (!gotOne && l && l.feature && l.feature.properties){
        Object.keys(l.feature.properties).forEach(k => attrs.add(k));
        gotOne = true;
      }
    });
    return Array.from(attrs).sort();
  }

  function getFeatureLayers(geoLayer){
    const out = [];
    if (!geoLayer) return out;
    geoLayer.eachLayer(l => { if(l && l.feature) out.push(l); });
    return out;
  }

  function valueFor(featureLayer, attr){
    const p = featureLayer && featureLayer.feature && featureLayer.feature.properties;
    return p ? p[attr] : undefined;
  }

  function popupLatLng(fl){
    try{
      if (fl.getBounds) return fl.getBounds().getCenter();
      if (fl.getLatLng) return fl.getLatLng();
    }catch(e){}
    return map.getCenter();
  }

  // ——— UI population ———
  Object.keys(registry).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name; opt.textContent = name; els.layer.appendChild(opt);
  });

  function populateAttributeSelect(){
    const name = els.layer.value; const layer = registry[name];
    els.attr.innerHTML = '';
    const attrs = getAttributes(layer);
    attrs.forEach(a => { const o = document.createElement('option'); o.value = a; o.textContent = a; els.attr.appendChild(o); });
  }

  function renderList(){
    const layerName = els.layer.value; const layer = registry[layerName];
    const attr = els.attr.value; const q = els.search.value.trim().toLowerCase();
    const features = getFeatureLayers(layer);
    els.list.innerHTML = '';
    let shown = 0;

    features.forEach((fl, idx) => {
      const v = valueFor(fl, attr);
      const vTxt = (v === undefined || v === null || v === '') ? '—' : String(v);
      if (q && vTxt.toLowerCase().indexOf(q) === -1) return;
      shown++;

      const row = document.createElement('div');
      row.className = 'row';
      row.setAttribute('role','listitem');
      row.innerHTML = `<span class="seq">${idx+1}</span><span class="val" title="${vTxt}">${vTxt}</span>`;

      row.addEventListener('click', () => {
        try{
          if (fl.getBounds) map.fitBounds(fl.getBounds(), {maxZoom: 19, padding:[20,20]});
          else if (fl.getLatLng) map.setView(fl.getLatLng(), Math.max(map.getZoom(), 18));
          const html = `<div><strong>${layerName}</strong><br>${attr}: ${vTxt}</div>`;
          L.popup().setLatLng(popupLatLng(fl)).setContent(html).openOn(map);
        } catch(e) { console.warn(e); }
      });

      els.list.appendChild(row);
    });

    els.stats.textContent = `${shown} of ${features.length} features`;
  }

  // ——— Events ———
  els.layer.addEventListener('change', () => { populateAttributeSelect(); renderList(); });
  els.attr.addEventListener('change', renderList);
  els.search.addEventListener('input', renderList);
  els.toggle.addEventListener('click', () => {
    const body = els.panel.querySelector('.body');
    if (body.style.display === 'none'){ body.style.display = 'block'; els.toggle.textContent = '–'; }
    else { body.style.display = 'none'; els.toggle.textContent = '+'; }
  });

  // ——— Init ———
  if (els.layer.options.length){
    populateAttributeSelect();
    renderList();
  } else {
    // Helpful message if registry mapping wasn't found
    els.list.innerHTML = '<div class="row"><span class="val">⚠️ Update the layer mapping in the script (search for <b>var layer_</b> in index.html) so Buildings/Vegetation point to your actual layer variables.</span></div>';
  }
})();
</script>
 </body>
</html>
